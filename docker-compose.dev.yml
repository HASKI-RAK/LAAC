# ===================================================================
# LAAC Development Environment (REQ-FN-013)
# ===================================================================
# This Docker Compose configuration provides a local development
# environment with hot-reload capabilities for rapid iteration.
#
# Usage:
#   docker compose -f docker-compose.dev.yml up
#
# Features:
#   - Hot-reload: Source code changes trigger automatic restart
#   - Local Redis: In-memory cache for development
#   - Port exposure: Direct access to app and Redis
# ===================================================================

version: "3.9"

services:
  # LAAC Application (Development Mode)
  # REQ-FN-013: Development service with hot-reload
  laac:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder  # Use builder stage for development
    container_name: laac-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      # Hot-reload: Bind mount source code for file watching
      - ./src:/app/src:ro
      - ./test:/app/test:ro
      # Preserve node_modules from container (don't overwrite)
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - laac-dev
    command: ["yarn", "run", "start:dev"]

  # Redis Cache (Development Mode)
  # REQ-FN-006: Cache service for development
  redis:
    image: redis:7-alpine
    container_name: laac-redis-dev
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - laac-dev
    volumes:
      - redis_data:/data

    # Note: For local dev we run without a password. If you
    # enable a password, set REDIS_PASSWORD in your .env and
    # add: command: ["redis-server", "--requirepass", "$REDIS_PASSWORD"]

  # LRS (Learning Record Store) - External Service Reference
  # REQ-FN-002: Configure LRS_URL in .env to point to your LRS instance
  # Options:
  #   1. Use external LRS: Set LRS_URL=https://your-lrs-instance.com/xapi
  #   2. Run local mock LRS: Add a mock service here or use a separate container
  #
  # Example mock LRS service (uncomment to enable):
  # lrs-mock:
  #   image: yetanalytics/lrsql:latest
  #   container_name: laac-lrs-dev
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - LRSQL_API_KEY_DEFAULT=test-api-key
  #   networks:
  #     - laac-dev

networks:
  laac-dev:
    driver: bridge

volumes:
  redis_data:
    driver: local

